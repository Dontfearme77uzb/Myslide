<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SlideSite — Firebase demo</title>
<style>
  /* --- basic styles --- */
  body { font-family: Inter, Arial, sans-serif; margin:0; background:#f5f7fb; color:#111; }
  .topbar { background:#0f1724; color:#fff; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
  .btn { background:#ff7a00; color:#fff; padding:8px 12px; border-radius:8px; border:0; cursor:pointer; }
  .container{max-width:980px;margin:20px auto;padding:0 16px;}
  .card{background:#fff;border-radius:12px;padding:14px;margin-bottom:14px;box-shadow:0 6px 18px rgba(15,23,36,0.06);}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;}
  input, button, select, textarea{font-size:15px}
  .muted{color:#64748b}
  /* menu */
  .menu { display:flex; gap:8px; align-items:center; }
  .link { background:#111827; color:#fff;padding:8px 10px;border-radius:8px;text-decoration:none; }
  /* hidden helper */
  .hidden{display:none;}
  .file-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-radius:8px;background:#f8fafc;margin-bottom:8px}
  .danger{background:#ef4444;color:#fff;padding:6px 10px;border-radius:8px;border:0;cursor:pointer}
  .small{font-size:13px}
</style>
</head>
<body>

<div class="topbar">
  <div><strong>SlideSite</strong></div>
  <div class="menu">
    <div id="userEmail" class="muted small">Not signed in</div>
    <button id="openLoginBtn" class="btn">Login / Register</button>
    <button id="logoutBtn" class="btn hidden">Logout</button>
  </div>
</div>

<div class="container">

  <!-- AUTH MODAL -->
  <div id="authCard" class="card hidden">
    <h3 id="authTitle">Login</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <input id="email" placeholder="Email" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e2e8f0" />
      <input id="password" type="password" placeholder="Password" style="flex:1;padding:10px;border-radius:8px;border:1px solid #e2e8f0" />
      <button id="authSubmit" class="btn">Login</button>
      <button id="switchToRegister" class="btn" style="background:#6b7280">Register</button>
    </div>
    <p class="muted small" style="margin-top:8px">Admin: <strong>jahongirumarov242@gmail.com</strong></p>
  </div>

  <!-- MAIN HERO -->
  <div class="card">
    <h2>Explore Presentations</h2>
    <p class="muted">Best educational and business slides</p>
  </div>

  <!-- UPLOAD AREA (visible when logged in) -->
  <div id="uploadSection" class="card hidden">
    <h3>Upload file</h3>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <input id="fileInput" type="file" />
      <input id="slideTitle" placeholder="File title" style="padding:8px;border-radius:8px;border:1px solid #e2e8f0" />
      <select id="category" style="padding:8px;border-radius:8px;border:1px solid #e2e8f0">
        <option>Business</option><option>Design</option><option>Tech</option><option>Education</option>
      </select>
      <button id="uploadBtn" class="btn">Upload to Firebase</button>
    </div>
    <div id="uploadProgress" class="small muted" style="margin-top:8px"></div>
  </div>

  <!-- USER DASHBOARD -->
  <div id="userPanel" class="card hidden">
    <h3>Your uploads</h3>
    <div id="userFilesList"></div>
  </div>

  <!-- ADMIN DASHBOARD -->
  <div id="adminPanel" class="card hidden">
    <h3>Admin — All uploads</h3>
    <div id="allFilesList"></div>
  </div>

</div>

<!-- Firebase SDK (compat - simpler for single-file demo) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/*
  IMPORTANT:
  1) Replace firebaseConfig below with your project's config from Firebase Console -> Project settings.
  2) Ensure Authentication (Email/Password), Firestore and Storage are enabled in Firebase Console.
*/

// ----- Admin email (saved as you provided) -----
const ADMIN_EMAIL = "jahongirumarov242@gmail.com";

// ----- Firebase config: REPLACE these with your real config -----
const firebaseConfig = {
  apiKey: "REPLACE_API_KEY",
  authDomain: "REPLACE_AUTH_DOMAIN",
  projectId: "REPLACE_PROJECT_ID",
  storageBucket: "REPLACE_STORAGE_BUCKET",
  messagingSenderId: "REPLACE_SENDER_ID",
  appId: "REPLACE_APP_ID"
};
// ----------------------------------------------------

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const storage = firebase.storage();
const db = firebase.firestore();

// UI elements
const openLoginBtn = document.getElementById('openLoginBtn');
const authCard = document.getElementById('authCard');
const authTitle = document.getElementById('authTitle');
const authSubmit = document.getElementById('authSubmit');
const switchToRegister = document.getElementById('switchToRegister');
const logoutBtn = document.getElementById('logoutBtn');
const userEmail = document.getElementById('userEmail');

const uploadSection = document.getElementById('uploadSection');
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const uploadProgress = document.getElementById('uploadProgress');
const slideTitle = document.getElementById('slideTitle');
const category = document.getElementById('category');

const userPanel = document.getElementById('userPanel');
const userFilesList = document.getElementById('userFilesList');
const adminPanel = document.getElementById('adminPanel');
const allFilesList = document.getElementById('allFilesList');

let isRegisterMode = false;

// Show login/register modal
openLoginBtn.addEventListener('click', () => {
  authCard.classList.toggle('hidden');
});

switchToRegister.addEventListener('click', () => {
  isRegisterMode = !isRegisterMode;
  authTitle.textContent = isRegisterMode ? 'Register' : 'Login';
  authSubmit.textContent = isRegisterMode ? 'Register' : 'Login';
});

// Register / Login
authSubmit.addEventListener('click', async () => {
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value.trim();
  if(!email || !password) { alert('Email va parol kiriting'); return; }

  try {
    if(isRegisterMode) {
      const userCred = await auth.createUserWithEmailAndPassword(email, password);
      // Save simple profile in Firestore
      await db.collection('users').doc(userCred.user.uid).set({ email: email, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      alert('Ro‘yxatdan o‘tildi. Login qiling.');
      isRegisterMode = false;
      authTitle.textContent = 'Login';
      authSubmit.textContent = 'Login';
    } else {
      await auth.signInWithEmailAndPassword(email, password);
      authCard.classList.add('hidden');
    }
  } catch(e) {
    alert('Xato: ' + e.message);
  }
});

// Logout
logoutBtn.addEventListener('click', () => auth.signOut());

// Auth state listener
auth.onAuthStateChanged(async (user) => {
  if(user) {
    userEmail.textContent = user.email;
    openLoginBtn.classList.add('hidden');
    logoutBtn.classList.remove('hidden');

    // show upload and user panel
    uploadSection.classList.remove('hidden');
    userPanel.classList.remove('hidden');

    // if admin
    if(user.email === ADMIN_EMAIL) {
      adminPanel.classList.remove('hidden');
    } else {
      adminPanel.classList.add('hidden');
    }

    // load user's files
    loadUserFiles(user.uid);
    // load all files for admin
    if(user.email === ADMIN_EMAIL) loadAllFiles();
  } else {
    userEmail.textContent = 'Not signed in';
    openLoginBtn.classList.remove('hidden');
    logoutBtn.classList.add('hidden');
    uploadSection.classList.add('hidden');
    userPanel.classList.add('hidden');
    adminPanel.classList.add('hidden');
    userFilesList.innerHTML = '';
    allFilesList.innerHTML = '';
  }
});

// Upload logic
uploadBtn.addEventListener('click', async () => {
  const user = auth.currentUser;
  if(!user) { alert('Iltimos avval login qiling'); return; }
  const file = fileInput.files[0];
  const title = slideTitle.value.trim() || (file ? file.name : '');
  const cat = category.value;

  if(!file) { alert('Iltimos fayl tanlang'); return; }

  const storageRef = storage.ref().child(`uploads/${user.uid}/${Date.now()}_${file.name}`);
  const uploadTask = storageRef.put(file);

  uploadProgress.textContent = 'Uploading... 0%';

  uploadTask.on('state_changed', snapshot => {
    const pct = Math.round((snapshot.bytesTransferred / snapshot.totalBytes) * 100);
    uploadProgress.textContent = `Uploading... ${pct}%`;
  }, error => {
    alert('Upload error: ' + error.message);
  }, async () => {
    const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
    // write to Firestore
    await db.collection('uploads').add({
      ownerUid: user.uid,
      ownerEmail: user.email,
      title: title,
      filename: file.name,
      category: cat,
      url: downloadURL,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    uploadProgress.textContent = 'Uploaded';
    fileInput.value = '';
    slideTitle.value = '';
    loadUserFiles(user.uid);
    if(user.email === ADMIN_EMAIL) loadAllFiles();
    alert('Fayl yuklandi');
  });
});

// Load files for user
async function loadUserFiles(uid) {
  userFilesList.innerHTML = '<div class="muted small">Loading...</div>';
  const q = await db.collection('uploads').where('ownerUid','==',uid).orderBy('createdAt','desc').get();
  userFilesList.innerHTML = '';
  if(q.empty) { userFilesList.innerHTML = '<div class="muted small">You have no uploads</div>'; return; }
  q.forEach(doc => {
    const data = doc.data();
    const div = document.createElement('div');
    div.className = 'file-item';
    div.innerHTML = `<div><strong>${escapeHtml(data.title)}</strong><div class="small muted">${escapeHtml(data.filename)} • ${escapeHtml(data.category)}</div></div>
                     <div style="display:flex;gap:8px;align-items:center">
                       <a class="link" href="${data.url}" target="_blank">Open</a>
                       <button class="danger small" onclick="deleteFile('${doc.id}','${data.url}')">Delete</button>
                     </div>`;
    userFilesList.appendChild(div);
  });
}

// Load all files (admin)
async function loadAllFiles() {
  allFilesList.innerHTML = '<div class="muted small">Loading...</div>';
  const q = await db.collection('uploads').orderBy('createdAt','desc').get();
  allFilesList.innerHTML = '';
  if(q.empty) { allFilesList.innerHTML = '<div class="muted small">No uploads yet</div>'; return; }
  q.forEach(doc => {
    const data = doc.data();
    const div = document.createElement('div');
    div.className = 'file-item';
    div.innerHTML = `<div><strong>${escapeHtml(data.title)}</strong><div class="small muted">${escapeHtml(data.filename)} • ${escapeHtml(data.category)} • ${escapeHtml(data.ownerEmail)}</div></div>
                     <div style="display:flex;gap:8px;align-items:center">
                       <a class="link" href="${data.url}" target="_blank">Open</a>
                       <button class="danger small" onclick="deleteFile('${doc.id}','${data.url}')">Delete</button>
                     </div>`;
    allFilesList.appendChild(div);
  });
}

// Delete file (both storage object and firestore doc) — only owner or admin
async function deleteFile(docId, fileUrl) {
  const user = auth.currentUser;
  if(!user) return alert('Not authorized');

  // confirm
  if(!confirm('Are you sure you want to delete this file?')) return;

  try {
    // find storage ref from URL
    // Firebase Storage URL shape: https://firebasestorage.googleapis.com/v0/b/<bucket>/o/<encodedPath>?alt=media...
    // Extract path between /o/ and ?alt
    const url = fileUrl;
    const match = url.match(/\/o\/(.*?)\?/);
    if(match && match[1]) {
      const encodedPath = match[1];
      const path = decodeURIComponent(encodedPath);
      // delete storage object
      await storage.ref(path).delete();
    }

    // delete firestore doc
    await db.collection('uploads').doc(docId).delete();
    alert('Deleted');
    // refresh lists
    loadUserFiles(user.uid);
    if(user.email === ADMIN_EMAIL) loadAllFiles();
  } catch(e) {
    alert('Delete error: '+ e.message);
  }
}

// helper to escape html
function escapeHtml(s) {
  if(!s) return '';
  return s.replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
}

</script>

</body>
</html>
